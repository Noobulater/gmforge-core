function runCommand(e,t){if(connection.alive&&connection.socket)connection.socket.emit("command",{name:e,data:t});else{if("chatEvent"==e)game.logs.data=game.logs.data||{},game.logs.data.events=game.logs.data.events||[],game.logs.data.events.push(t),game.logs.update();else if("diceCheck"==e){var a=Object.keys(game.events.data).length;game.events.data["ev"+a]=sync.obj(),game.events.data["ev"+a].data=t,game.events.update();var i={text:t.msg,evID:"ev"+a,ui:t.ui,user:sync.eval("@me.pName",sync.defaultContext()),href:t.icon};game.logs.data=game.logs.data||{},game.logs.data.events=game.logs.data.events||[],game.logs.data.events.push(i),game.logs.update()}else"media"==e&&($("#dragMedia").length||media_init(),mediaPlayer.command(t));console.log(e+" : "+t+" <NO CONNECTION>")}}function connection_init(){function e(){isNaN(ntp.offset())||(_offset=ntp.offset()),setTimeout(function(){e()},1e4)}var t=localStorage.getItem(getCookie("offlineGame")),a=io();ntp.init(a),connection.alive||setTimeout(function(){e()},1e3),a.emit("auth",{userID:getCookie("UserID")}),a.on("p2p",function(e){comms.message(e)}),a.on("disconnect",function(e){console.log("disconnected"),$.ajax({url:"/",error:function(e){if(console.log(e),game.config&&game.config.data.offline){layout.page({title:"You have entered offline mode",prompt:"Editing is limited, but you can still access all your data. Rejoin the server and you will be able to upload your changes.",blur:.8})}else{layout.page({title:"Oops, looks like your connection was broken!",prompt:"The server appears to be down, or your internet connection is. Either way please refresh the page to resume editing.",blur:.8})}},dataType:"json",success:function(e){sendAlert({text:"Reconnect initilaized"}),console.log("Reconnect Attempt"),connection_init()},type:"GET"})}),a.on("shutdown",function(e){function t(e,a){if(e)return _shutDownTime-dateCorrected()>0?(e.text(String(Math.floor((_shutDownTime-dateCorrected(-500))/1e3)).formatTime()),setTimeout(function(){t(e)},50),!0):_shutDownTime-dateCorrected()>-1500?(e.text("0".formatTime()),setTimeout(function(){t(e)},1e3),!0):(e.parent().remove(),!0)}var a=$("<div>");a.addClass("flexcolumn focus outline flexmiddle spadding smooth fit-xy");var i=$("<b>").appendTo(a);i.attr("title",e.msg),i.css("font-size","3.0em"),a.append("<p>"+e.msg+"</p>"),_shutDownTime=e.endTime,t(i),sendAlert({text:e.msg||"Server will shut down soon, please wrap up your changes.",duration:18e4}),notify(a,{title:"Server Shutdown"})}),a.on("command",function(e){var t=e.header;if(t){var a=t.id,i=duplicate(e.data);if("alert"==t.type)sendAlert(i);else if("updateCollection"==t.type)game.locals.stamps&&(game.locals.stamps.data.sets=i,game.locals.stamps.update());else if("view"==t.type){for(var o in game.state._apps)$("#"+game.state._apps[o]).length&&($("#"+game.state._apps[o]).attr("tab",i.index),$("#"+game.state._apps[o]).attr("resourcePath",i.path),$("#"+game.state._apps[o]).attr("forced",!0));game.state.update(),game.config.update(),layout.coverlay($(".piece-quick-edit"))}else if("updateBoardLayer"==t.type)t.userID!=getCookie("UserID")&&boardApi.pix.applyUpdate(t.userID,i);else if("event"==t.type){if(!game.events.data[a]){var s=sync.obj(a);game.events.data[a]=s}if(t.ui&&util.contains(i.players,getCookie("UserID"))&&t.popout){var n=sync.newApp(t.ui);n.attr("event","true"),game.events.data[a].addApp(n);layout.page({title:i.title,prompt:i.prompt,blur:.5}).append(n)}game.events.data[a].update(i),game.events.update()}else if("cursor"==t.type){if(game.entities.data[i.id]&&null!=i){var r=getEnt(i.id).data;r.cursors=r.cursors||{},r.cursors[a]=i.data;var l=$(".board-"+i.id);a!=getCookie("UserID")&&!hasSecurity(a,"Assistant Master")&&hasSecurity(getCookie("UserID"),"Assistant Master")&&$(".tab").each(function(){if($(this).is(":visible")){var e=game.state.data.tabs[$(this).attr("tabKey")];if(e&&e.index==i.id&&(layout.coverlay("player-marker-"+a),game.players.data[a])){for(var t=14,o=0;o<Object.keys(game.players.data).length;o++)if(Object.keys(game.players.data)[o]==a&&a!=getCookie("UserID")){t+=10*o;break}var s=$("<div>").appendTo($(this));s.addClass("outline"),s.attr("id","player-marker-"+a),s.attr("index",e.index),s.attr("uID",a),s.attr("title",game.players.data[a].displayName),s.css("position","absolute"),s.css("left",t),s.css("bottom","0"),s.css("width","8px"),s.css("height","8px"),s.css("background-color",game.players.data[a].color||"white"),s.css("border-top-left-radius","8px"),s.css("border-top-right-radius","8px")}}})}}else if("move"==t.type){if(game.entities.data[a]&&null!=i&&t.userID!=getCookie("UserID")&&i.data){var d=getEnt(a),r=d.data,c=i.data,p=r.layers[i.layer][i.type][i.index],u=.1*util.dist(p.x,c.x,p.y,c.y)/Math.max(c.w,c.h);"w"==i.type?(r.layers[i.layer][i.type][i.index]=c,$(".application[ui-name='ui_board']").each(function(){if(boardApi.pix.apps[$(this).attr("id")]&&boardApi.pix.apps[$(this).attr("id")].board==a){var e=boardApi.pix.apps[$(this).attr("id")].stage,t=e.children[1].children[i.layer];if(t&&t.children&&t.children.length){var o=t.children[4];o.children&&o.children[i.index]&&o.children[i.index].update()}boardApi.pix.rebuildFog(d,$(this))}})):p.i!=c.i||p.eID!=c.eID?(r.layers[i.layer][i.type][i.index]=c,boardApi.pix.updateObject(i.layer,i.type,i.index,d),$(".piece-quick-edit-app").length&&$(".piece-quick-edit-app").attr("idstr")==a+"-"+i.layer+"-p-"+i.index&&sync.updateApp($(".piece-quick-edit-app"),d)):($(".application[ui-name='ui_board']").each(function(){var e=$(this).attr("UserID")||getCookie("UserID");if(boardApi.pix.apps[$(this).attr("id")]&&boardApi.pix.apps[$(this).attr("id")].board==a){var t=boardApi.pix.apps[$(this).attr("id")].stage,o=t.children[1].children[i.layer];if(o&&o.children&&o.children.length)if("p"==i.type){var s=o.children[2];if(s.children&&s.children[i.index]&&(s.children[i.index].animate(c,p,u),boardApi.pix.fog[a]&&boardApi.pix.fog[a].length&&c.eID)){var n=getEnt(c.eID);if(n&&n.data&&"c"==n.data._t&&hasSecurity(e,"Visible",n.data)){var r=null;if(c.eID&&c.o&&c.o.Sight){var n=getEnt(c.eID),g=sync.defaultContext();n&&n.data&&(g[n.data._t]=duplicate(n.data));var m=c.o.Sight;r=boardApi.pix.scale(sync.eval(m.d,g),d,!0)}boardApi.pix.apps[$(this).attr("id")].views[i.layer+"-"+i.type+"-"+i.index]=boardApi.pix.buildDynamicFog(d,$(this),c.x+c.w/2,c.y+c.h/2,r),boardApi.pix.rebuildDynamicFog(d,$(this))}else boardApi.pix.apps[$(this).attr("id")].views&&boardApi.pix.apps[$(this).attr("id")].views[i.layer+"-p-"+x]&&(boardApi.pix.apps[$(this).attr("id")].views[i.layer+"-p-"+x].destroy(!0),delete boardApi.pix.apps[$(this).attr("id")].views[i.layer+"-p-"+x],boardApi.pix.rebuildDynamicFog(l,$(this)))}}else if("d"==i.type){var f=o.children[3];f.children&&f.children[i.index]&&f.children[i.index].animate(c,p,u)}else if("t"==i.type){var h=o.children[1];h.children&&h.children[i.index]&&h.children[i.index].animate(c,p,u)}}}),r.layers[i.layer][i.type][i.index]=c)}}else if("handout"==t.type){var g=game.entities.data[a];if(g&&g.data){i.sender&&sendAlert({text:"Handout from "+getPlayerName(i.sender)});var m=$("<div>");if(m.addClass("flexcolumn flex"),"b"==g.data._t){var f=sync.newApp("ui_board").appendTo(m);f.attr("viewOnly","true"),g.addApp(f)}else{var f=sync.newApp(i.ui||"ui_renderPage").appendTo(m);f.attr("viewOnly","true"),g.addApp(f)}m.attr("viewOnly",!hasSecurity(getCookie("UserID"),"Rights",g.data));var h=ui_popOut({title:i.name,target:$("body"),minimize:!0,maximize:!0,dragThickness:"0.5em",resizable:!0,style:{width:assetTypes[g.data._t].width,height:assetTypes[g.data._t].height}},m);h.css("padding","0px"),h.addClass("floating-app"),h.resizable()}}else if("entity"==t.type){if(!game.entities.data[a]&&null!=i){var s=sync.obj(a);game.entities.data[a]=s}null==i?delete game.entities.data[a]:t.merge?game.entities.data[a].update(i,Object.keys(i)):game.entities.data[a].update(i),game.entities.update()}else if("storage"==t.type){if(!game.locals.storage){var s=sync.obj("storage");game.locals.storage=s}var v;t.add?(game.locals.storage.data.l.push(i),v=game.locals.storage.data):v=i.data;var y=[];for(var x in v.l){var b=v.l[x];if(!isNaN(b._uid)||v.s[b._uid])if(b._uid&&v.s[b._uid]){v.s[b._uid]instanceof Object||(v.s[b._uid]={data:v.s[b._uid]});var w=v.s[b._uid].data;if(!(w instanceof Object))try{var C=JSON.parse(w);C._uid=b._uid,v.s[b._uid]=sync.obj(getCookie("UserID")+"_"+b._uid),v.s[b._uid].data=C}catch(e){v.s[b._uid]=sync.obj(getCookie("UserID")+"_"+b._uid),v.s[b._uid].data=duplicate(game.templates.page)}}else y.push(x);else!function(e){$.ajax({url:"/retrieveAsset?id="+e._uid,error:function(e){console.log(e)},dataType:"json",success:function(t){var a=game.locals.storage.data;a.s[e._uid]instanceof Object||(a.s[e._uid]=t);var i=a.s[e._uid].data;if(!(i instanceof Object))try{var o=JSON.parse(i);o._uid=e._uid,a.s[e._uid]=sync.obj(getCookie("UserID")+"_"+e._uid),a.s[e._uid].data=o}catch(t){a.s[e._uid]=sync.obj(getCookie("UserID")+"_"+e._uid),a.s[e._uid].data=duplicate(game.templates.page)}game.locals.storage.update(a)},type:"GET"})}(b)}for(var o=y.length-1;o>=0;o--)i.data.l.splice(y[o],1);game.locals.storage.update(v)}else if("players"==t.type){if(!game.players){var s=sync.obj("players");game.players=s}for(var k in game.players.data)$(".cursor-"+k).length&&!i[k]&&$(".cursor-"+k).remove();game.players.update(i)}else if("config"==t.type)game.config.update(i),game.config.data.tracks&&audioChannels.prepTracks(game.config.data.tracks);else if("music"==t.type)if(i.cmd)audioChannels[i.cmd](i.index,i.ind,i.val);else{var T=new Audio(i.src);T.volume=.2,T.play()}else if("effect"==t.type)util.playEffect(i);else if("tags"==t.type)game.templates.tags=i;else if("state"==t.type)if(game.state.update(i),game.state.data.combat){if(t.combat&&hasSecurity(getCookie("UserID"),"Assistant Master")&&$("#main-menu").length&&0==$("#main-menu").css("opacity")&&$("#main-menu").attr("docked")&&($("#combat-button").click(),util.dockReveal($("#main-menu"))),!hasSecurity(getCookie("UserID"),"Assistant Master")&&getPlayerCharacter(getCookie("UserID"))){var g=getPlayerCharacter(getCookie("UserID"));if(g&&g.data){if(Object.keys(game.state.data.combat.engaged[g.id()]).length)layout.coverlay("olay-join-combat"),layout.coverlay("join-combat");else if(game.state.data.combat&&0==$("olay-join-combat").length){var _=Math.max(util.getMaxZ(".main-dock"),util.getMaxZ(".ui-popout")),D=layout.overlay({target:$("body"),id:"olay-join-combat",style:{"background-color":"rgba(0,0,0,0.7)"}});D.css("z-index",_+1),D.fadeIn(),D.addClass("flexcolumn flexmiddle"),D.click(function(){layout.coverlay(D),layout.coverlay("join-combat")});var I=$("<div>").appendTo(D);if(I.css("position","absolute"),I.css("width","100%"),I.css("top","10%"),I.addClass("flexmiddle bounce"),I.hide(),I.fadeIn(),sync.rawVal(g.data.info.img)){var A=$("<div>").appendTo(D);A.css("width","30vw"),A.css("height","60vh"),layout.mobile&&(A.css("width","200px"),A.css("height","300px")),A.css("background-image","url('"+sync.rawVal(g.data.info.img)+"')"),A.css("background-size","cover"),A.css("background-repeat","no-repeat"),A.css("background-position","center 0"),A.css("box-shadow","0 0 8px 8px #111 inset"),A.css("border-radius","2px")}var j=["IT'S FIGHTING TIME","Things are about to get ugly","What's that? Combat you say?","CHAARRRRGEEE!","Still More FIGHTING",'"... And I\'m all out of gum"',"Raise those fists!"],P=$("<highlight>").appendTo(I);P.text(j[Math.floor(Math.random()*j.length)]),P.addClass("combat"),layout.mobile&&(I.css("top",""),I.css("bottom","20%"),P.css("font-size","1.6em")),_actions["Set/Roll Initiative"].click(null,D,g,D,{pump:!0}),$("#join-combat").css("z-index",_+2)}}else layout.coverlay("olay-join-combat"),layout.coverlay("join-combat")}}else layout.coverlay("olay-join-combat"),layout.coverlay("join-combat");else if("logs"==t.type&&game.logs)game.logs.update(i);else if("comms"==t.type){if("localMute"==i.cmd)comms.localMute(i.from);else if("localUnMute"==i.cmd)comms.localUnMute(i.from);else if("reveal"==i.cmd)if(hasSecurity(i.from,"Assistant Master")&&i.players&&i.players.length)for(var o=0;o<i.players.length;o++)comms.reveal(i.players[o]);else comms.reveal(i.from);else if("hide"==i.cmd)if(hasSecurity(i.from,"Assistant Master")&&i.players&&i.players.length)for(var o=0;o<i.players.length;o++)comms.hide(i.players[o]);else comms.hide(i.from);if("disconnect"==i.cmd)$("#web-cam-"+i.from).fadeOut();else if(hasSecurity(i.from,"Assistant Master"))if("mute"==i.cmd)for(var o=0;o<i.players.length;o++)comms.mute(i.players[o]);else if("unmute"==i.cmd)for(var o=0;o<i.players.length;o++)comms.unmute(i.players[o]);else if("deafen"==i.cmd)for(var o=0;o<i.players.length;o++)comms.deafen(i.players[o]);else if("undeafen"==i.cmd)for(var o=0;o<i.players.length;o++)comms.undeafen(i.players[o]);else if("channel"==i.cmd)for(var o=0;o<i.players.length;o++)comms.channel(i.players[o],i.channels)}else if("media"==t.type)$("#dragMedia").length||media_init(),mediaPlayer.command(i);else if("reaction"==t.type){if("true"==getCookie("disableReactions"))return!1;if(_nextSound<Date.now()&&!_winHasFocus){var S=new Audio("/sounds/snap.wav");S.volume=.1,S.play(),_nextSound=Date.now()+1e4}var U=i,F=!1;util.matchYoutube(i)&&(F=util.matchYoutube(i),i="/content/youtube.ico");var M=ui_processMedia(i,{id:"reaction-media-"+t.id});M.css("transition","height 1s"),M.css("pointer-events","none"),M.css("min-width",.1*Math.max($(window).width(),$(window).height())+"px"),M.css("min-height",.1*Math.max($(window).width(),$(window).height())+"px");var z=$("#player-icon-"+t.id),O="top";$("#web-cam-"+t.id).length&&(z=$("#web-cam-"+t.id),O=null);var P="";layout.mobile&&(z=$($(".main-dock")[3]),P=game.players.data[a].displayName+"'s reaction");var E;if(M.is("img"))M.css("width",Math.max($("#player-image-plate-"+a).outerWidth(),150)),layout.mobile&&M.css("width",Math.max(z.width()/2,150)),M.on("load",function(){var e=ui_popOut({target:z,align:O,id:"reaction-frame-"+t.id,userID:t.id,noCss:!0,hideclose:!0,title:P,style:{"background-color":"white",cursor:"pointer","max-height":"50vh","max-width":"35vw"}},M),a=util.getMaxZ(".ui-popout");e.css("z-index",a+1),e.contextmenu(function(){return layout.coverlay("reaction-frame-"+t.id,500),!1}),e.click(function(){if(F)return void(hasSecurity(getCookie("UserID"),"Assistant Master")&&(runCommand("media",{cmd:"update",data:F}),$(this).remove()));var e=$("#reaction-media-"+$(this).attr("UserID")),t=layout.overlay({target:$("body"),style:{"background-color":"rgba(0,0,0,0.8)",cursor:"pointer","pointer-events":"auto"}}),a=util.getMaxZ(".ui-popout");t.css("z-index",a+1),t.addClass("flexmiddle");var i=e.outerWidth()/e.outerHeight(),o=$("<div>").appendTo(t);o.css("background-color","white");var s=$("<img>").appendTo(o);i>1?(s.css("height","auto"),s.css("width",.6*$(window).outerWidth())):(s.css("height",.6*$(window).outerHeight()),s.css("width","auto")),s.attr("src",e.attr("src")),s.css("pointer-events","none"),t.click(function(){E=!0,layout.coverlay($(this),500)})}),U.match(".gif")?setTimeout(function(){(!$("#reaction-frame-"+t.id+":hover").length||layout.mobile&&!E)&&layout.coverlay(e,500)},12e3):setTimeout(function(){(!$("#reaction-frame-"+t.id+":hover").length||layout.mobile&&!E)&&layout.coverlay(e,500)},4e3),getCookie("UserID")!=t.id&&hasSecurity(t.id,"Assistant Master")&&(E=!0,e.click())});else{M.attr("width",Math.max($("#player-image-plate-"+a).outerWidth(),150)),layout.mobile&&M.css("width",Math.max(z.width()/2,150)),M.bind("ended",function(){$("#reaction-frame-"+a+":hover").length&&!layout.mobile?M[0].play():layout.coverlay("reaction-frame-"+a,500)});var N=ui_popOut({target:z,align:O,id:"reaction-frame-"+t.id,userID:t.id,title:P,noCss:!0,hideclose:!0,style:{"background-color":"white",cursor:"pointer"}},M),G=util.getMaxZ(".ui-popout");N.css("z-index",G+1),N.contextmenu(function(){return layout.coverlay("reaction-frame-"+t.id,500),!1}),N.click(function(){var e=$("#reaction-media-"+$(this).attr("UserID")),t=layout.overlay({target:$("body"),style:{"background-color":"rgba(0,0,0,0.8)",cursor:"pointer","pointer-events":"auto"}}),a=util.getMaxZ(".ui-popout");t.css("z-index",a+1),t.addClass("flexmiddle");var i=e.outerWidth()/e.outerHeight();e[0].pause();var o=$("<video>").appendTo(t);i>1?(o.attr("height","auto"),o.attr("width",.6*$(window).outerWidth())):(o.attr("height",.6*$(window).outerHeight()),o.attr("width","auto")),o.attr("muted",!0),o.attr("autoplay",!0),o.attr("loop",!0),o.attr("src",e.attr("src")),o.css("pointer-events","none"),o[0].currentTime=e[0].currentTime,o[0].play(),t.click(function(){layout.coverlay($(this),500),e[0].currentTime=o[0].currentTime,e[0].play()})}),getCookie("UserID")!=t.id&&hasSecurity(t.id,"Assistant Master")&&N.click()}}}}),a.on("goOffline",function(e){try{game.owner==getCookie("UserID")&&(game.config.data.offline=e.offline,setCookie("offlineGame",e.gameID,999999999999999),localStorage.setItem(getCookie("offlineGame"),JSON.stringify(game))),connection.alive=!1,a.disconnect(),sendAlert({text:"You are now offline"});for(var i in _syncList)_syncList[i].update()}catch(e){sendAlert({text:"Game is too large to be taken offline"}),runCommand("goOnline",JSON.stringify(JSON.parse(t||"{}").entities)),setCookie("offlineGame","")}}),a.on("breakConnection",function(e){game.locals.gameBackup=duplicate(game),connection.alive=!1,a.disconnect()}),a.on("initialize",function(e){layout.mobile&&$("#viewPort").empty(),setupGame(),game.templates=e.templates;var t={};for(var i in game.templates.constants)t[String(i).toLowerCase()]=game.templates.constants[i];if(game.config.data=e.config,game.state.data=e.state,game.owner=e.owner,game.locals.gameList=e.games,game.id=e.gameID,_authToken=e.authToken,game.user=e.userData,game.state.data.setting=game.state.data.setting||{},game.owner==getCookie("UserID"))for(var o in game.config.data.scripts){var s=$("<script>").appendTo("body");s.attr("src",game.config.data.scripts[o])}for(var n in e.events){var r=e.events[n];if(!game.events.data[n]){var l=sync.obj(n);game.events.data[n]=l}game.events.data[n].update(r),game.events.update()}for(var n in e.entities){var r=e.entities[n];if(!game.entities.data[n]&&null!=r){var l=sync.obj(n);game.entities.data[n]=l}null==r?delete game.entities.data[n]:game.entities.data[n].update(r),game.entities.update()}if(game.templates.generation="\n\ufeffNo Template={<>}",$.get("/"+game.config.data.game+".txt",function(e){game.templates.generation="\n"+e}),game.logs.data=e.logs,a.emit("p2p",getCookie("UserID")),connection.alive||(layout.init(),loadNotify()),connection.alive=!0,hasSecurity(getCookie("UserID"),"Assistant Master")||game.config.data.players&&game.config.data.players[getCookie("UserID")]&&(null!=game.config.data.players[getCookie("UserID")].entity||getEnt(game.config.data.players[getCookie("UserID")].entity))){if(game.config.data.players&&game.config.data.players[getCookie("UserID")]&&null!=game.config.data.players[getCookie("UserID")].entity&&getEnt(game.config.data.players[getCookie("UserID")].entity)){runCommand("selectPlayerColor",{col:game.config.data.players[getCookie("UserID")].color,userID:getCookie("UserID")});var d=getEnt(game.config.data.players[getCookie("UserID")].entity);assetTypes[d.data._t].preview(d,$("body"));runCommand("selectPlayerEntity",{id:d.id()}),sendAlert({text:"Impersonating Character"}),$(".chatType").text("IC"),$(".chatType").addClass("highlight alttext"),$(".chatType").attr("title","In Character"),$(".application[ui-name='_imperson']").attr("src",sync.rawVal(d.data.info.img)||"/content/icons/blankchar.png"),$(".application[ui-name='_imperson']").attr("ICText",sync.rawVal(d.data.info.name)),$(".application[ui-name='_imperson']").each(function(){sync.updateApp($(this),game.players)})}}else{var c=layout.page({title:"Choose your Character",prompt:"Select or create a character you will be playing with",blur:.5,id:"character-select",width:"auto"}),p=$("<div>").appendTo(c);p.addClass("flexrow");var u=sync.render("ui_colorPicker")(sync.dummyObj(),c,{hideColor:!0,vertical:!0,colors:["rgba(34,34,34,1)","rgba(187,0,0,1)","rgba(255,153,0,1)","rgba(255,240,0,1)","rgba(0,187,0,1)","rgba(0,115,230,1)","rgba(176,0,187,1)","rgba(255,115,255,1)","rgba(255,255,255,1)"],colorChange:function(e,t,a){runCommand("selectPlayerColor",{col:a,userID:getCookie("UserID")}),sendAlert({text:"Color Selected"}),u.css("background",a)}}).appendTo(p),g=$("<div>").appendTo(p);g.addClass("flexrow lightoutline smooth flexwrap flexaround");var m=sync.render("ui_assetPicker")(game.entities,g,{rights:"Rights",filter:"c",sessionOnly:!0,select:function(e,t,a,i,o){assetTypes[a.data._t].preview(a,$("body"));runCommand("selectPlayerEntity",{id:a.id()}),sendAlert({text:"Impersonating Character"}),$(".chatType").text("IC"),$(".chatType").addClass("highlight alttext"),$(".chatType").attr("title","In Character"),$(".application[ui-name='_imperson']").attr("src",sync.rawVal(a.data.info.img)||"/content/icons/blankchar.png"),$(".application[ui-name='_imperson']").attr("ICText",sync.rawVal(a.data.info.name)),$(".application[ui-name='_imperson']").each(function(){sync.updateApp($(this),game.players)}),layout.coverlay("character-select",500)}}).appendTo(g);m.css("width",assetTypes.assetPicker.width),m.css("height",assetTypes.assetPicker.width),m.addClass("white")}setTimeout(function(){runCommand("retreiveStorage")},100)}),connection.socket=a}function openSplash(e,t){var a=layout.overlay({target:$("body"),id:"splash-screen"});a.addClass("flexrow flexaround"),a.css("background","rgba(0,0,0,0.8)"),a.css("font-size","");var i=util.getMaxZ(".ui-popout");if(a.css("z-index",i+1),!getCookie("UserID").valid()){$("#auth").click(function(){ui_popOut({target:$(this),align:"bottom",id:"auth-dialog",style:{width:"10vw"}},authDialog())})}var o=$("<div>").appendTo(a);o.addClass("flexcolumn flex lpadding"),o.load("https://files.gmforge.io/file/tabs/left.html");var s=$("<div>").appendTo(a);s.addClass("flexcolumn flex2 flexmiddle");var o=$("<div>").appendTo(a);o.addClass("flexcolumn flex lpadding"),o.load("https://files.gmforge.io/file/tabs/right.html");var n=$("<div>").appendTo(s);n.addClass("flexcolumn flexmiddle"),n.css("background","radial-gradient(rgba(255,255,255,0.4), rgba(255,255,255,0.3), rgba(255,255,255,0.05), rgba(255,255,255,0), rgba(255,255,255,0))");var r=$("<div>").appendTo(n);r.css("width","35vh"),r.css("height","35vh"),r.css("background-image","url('/content/brand.png')"),r.css("background-repeat","no-repeat"),r.css("background-size","cover"),r.css("background-position","center");var l=$("<text>").appendTo(s);l.addClass("flexcolumn flexmiddle hover2 lrpadding"),l.css("color","white"),l.css("font-size","2em"),l.css("font-family","Arial"),l.css("text-shadow","0px 0px 1px rgb(235,235,228)"),l.css("margin-bottom","1em"),l.text("Use in fullscreen!"),l[0].addEventListener("click",function(){var e=document.documentElement;(e.requestFullscreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullscreen).call(e)});var d=$("<div>").appendTo(s);if(d.addClass("flexcolumn"),d.css("min-width","262px"),!window.mobilecheck()&&e){var c=$("<button>").appendTo(d);c.addClass("hardoutline smooth highlight flex flexmiddle hover2 padding"),c.css("margin-bottom","1em");var l=$("<text>").appendTo(c);l.addClass("flexmiddle"),l.css("color","white"),l.css("font-size","2em"),l.css("font-family","Arial"),l.css("text-shadow","0px 0px 3px black"),l.text("Resume"),c.click(function(){layout.coverlay($("#splash-screen"),500)})}if("true"==$("#viewPort").attr("host")||1==$("#viewPort").attr("host")){var p=$("<div>").appendTo(d);p.addClass("flexcolumn hardoutline smooth background flex flexmiddle hover2 padding");var l=$("<text>").appendTo(p);l.addClass("flexmiddle bold"),l.attr("id","join"),l.css("color","white"),l.css("font-size","2em"),l.css("font-family","Arial"),l.css("text-shadow","0px 0px 3px black"),l.text("Join a Game!");var u=!1;p.click(function(){$(this);if($("#join").fadeOut(500),$(this).css("min-height",$(this).height()),u)return!0;u=!0,setTimeout(function(){var e=genInput({parent:p,classes:"fit-x line alttext margin middle subtitle",placeholder:"Place Game Invite here"}),t=$("<div>").appendTo(p);t.addClass("fit-x"),t.text("Join through Invite"),t.css("font-size","1.4em"),t.css("font-family","Arial"),t.click(function(){e.match("http")?window.location.href=e.val():window.location.href="http://"+e.val()})},400)});var g=$("<div>").appendTo(d);g.addClass("hardoutline smooth background flex flexmiddle hover2 padding");var l=$("<text>").appendTo(g);l.addClass("flexmiddle bold"),l.attr("id","start"),l.css("color","white"),l.css("font-size","2em"),l.css("font-family","Arial"),l.css("text-shadow","0px 0px 3px black"),l.text("Start a Game!");var m=!1;g.click(function(){if($("#start").fadeOut(),$(this).css("min-height",$(this).height()),m)return!0;m=!0,setTimeout(function(){var e=$("<div>").appendTo(g),t=(sync.render("ui_filePicker")(sync.obj(),e,{filter:"world",hideURL:!0,change:function(e,t,a){$.ajax({url:"/loadGame",error:function(e){console.log(e)},dataType:"json",data:{gameData:a,gameName:a},success:function(e){window.location.href="/join",layout.coverlay($("#splash-screen"),500)},type:"GET"})}}).addClass("white smooth").css("color","#333").css("width","400px").css("height","200px").appendTo(e),$("<button>").appendTo(e));t.addClass("highlight alttext"),t.css("font-size","1.2em"),t.append("Start a New Game"),t.click(function(){var e=($(this).attr("index"),layout.page({title:"Creating Game...",prompt:"",width:"800px",blur:.5,id:"gamePreview",style:{"z-index":"100000000000000"}})),t=$("<div>").appendTo(e);t.addClass("flexcolumn"),game.locals.createSession=sync.obj("createSession"),game.locals.createSession.data={name:sync.newValue("Enter Your Game Title","An adventure begins..."),password:sync.newValue("Enter Your Password"),capacity:sync.newValue("Max Players",1,1,10),img:sync.newValue("Image Goes Here")};var a=$("<div>").appendTo(t);a.addClass("flexcolumn");var i=$("<div>").appendTo(a);i.append($("<b>Sample Games</b>").addClass("flexmiddle"));var o=$("<div>").appendTo(i);o.addClass("flexrow flexwrap smooth");for(var s in game.locals.gameList)if(game.locals.gameList[s].show){var n=$("<div>").appendTo(o);n.addClass("hover2 outline smooth"),game.locals.createSession.data.game==s&&n.addClass("highlight"),n.css("background-image","url('"+sync.rawVal(game.locals.gameList[s].info.img)+"')"),n.css("background-repeat","no-repeat"),n.css("background-position","center"),n.css("background-size","cover"),n.css("width","9em"),n.css("height","6em"),game.locals.gameList[s].beta&&(n.css("position","relative"),n.append("<highlight style='-webkit-text-stroke-color:white; position : absolute; top:0; left:0; font-size:0.8em; font-family:Arial;' class='highlight outline smooth lrpadding'>Beta</highlight>")),n.attr("index",s),n.attr("img",sync.rawVal(game.locals.gameList[s].info.img)),n.click(function(){game.locals.createSession.data.game=$(this).attr("index"),game.locals.createSession.data.img=$(this).attr("img"),game.locals.createSession.data.templates=game.locals.gameList[$(this).attr("index")].templates,game.locals.createSession.update();var e=sync.obj();e.data=duplicate(game.locals.gameList[$(this).attr("index")].templates.character),game.templates=game.templates||game.locals.gameList[$(this).attr("index")].templates,c.empty(),d.width(375);var t=sync.render("ui_characterSheet")(e,n,{sheet:game.locals.gameList[$(this).attr("index")].templates.display.sheet,viewOnly:!0,local:!0}).appendTo(c);t.css("width","750px"),t.css("height","800px"),t.css("zoom","50%"),o.children().each(function(){$(this).removeClass("highlight")}),$(this).addClass("highlight"),u.show()});var r=$("<p>").appendTo(n);r.addClass("fit-xy alttext flexmiddle subtitle"),r.css("background","linear-gradient(to top, rgba(0,0,0,0), rgba(0,0,0,0.4), rgba(0,0,0,0))"),r.text(sync.rawVal(game.locals.gameList[s].info.name)),r.hide(),n.hover(function(){$(this).children().fadeIn()},function(){$(this).children().fadeOut()})}var l=$("<div>").appendTo(t);l.addClass("flexcolumn flex");var d=$("<div>"),c=$("<div>").appendTo(l);c.addClass("flexcolumn fit-x flexmiddle"),d.css("height","400px");var p=$("<div>").appendTo(l);p.addClass("flexcolumn flexaround flex");var u=$("<button>").appendTo(p);u.addClass("flexmiddle highlight alttext"),u.css("font-size","2em"),u.append("Create"),u.hide(),u.click(function(){var e=game.locals.createSession.data;e.templates;ui_prompt({target:$(this),inputs:{"File Name":{placeholder:"No Special Characters"}},style:{"z-index":"10000000000000000000000000"},click:function(t,a){a["File Name"].val()&&$.ajax({url:"/loadGame",error:function(e){console.log(e)},dataType:"json",data:{gameName:"/custom/"+a["File Name"].val()+".world",gameKey:e.game},success:function(e){window.location.href="/join",layout.coverlay($("#splash-screen"),500)},type:"GET"})}})})})},800)});var f=$("<div>").appendTo(s);f.addClass("flexcolumn flexmiddle"),f.css("height","8vh"),f.append("<text style='color : white;' class='subtitle'>Game Master, LLC Â© 2017</text>"),f.append("<a class='subtitle' style='color : white;' href='http://wiki.gmforge.io/index.php/Terms_of_Service' target='_'>Terms of Service</a>"),"true"==$("#redeemCode").attr("about")&&($("#about").click(),$("#redeemCode").removeAttr("about"))}else for(var h=1;h<10;h++){var g=$("<div>").appendTo(d);g.addClass("button smooth white hover2 flex flexmiddle padding"),g.attr("index",h);var l=$("<text>").appendTo(g);l.addClass("flexmiddle bold"),l.css("font-family","Arial"),l.css("text-shadow","0px 0px 3px black"),l.text("Join as Player "+h),g.click(function(){window.location.href="/join?userID=player_"+$(this).attr("index")})}}!function(e){var t,a={},i=[];a.init=function(e,a){a=a||{},t=e,t.on("ntp:server_sync",o),setInterval(s,a.interval||1e3)};var o=function(e){var t=Date.now()-e.t1+(Date.now()-e.t0)/2;i.unshift(t),i.length>10&&i.pop()};a.offset=function(){for(var e=0,t=0;t<i.length;t++)e+=i[t];return e/=i.length};var s=function(){t.emit("ntp:client_sync",{t0:Date.now()})};"function"==typeof define&&define.amd?define("ntp",[],function(){return a}):e.ntp=a}(window);var _nextSound=0,_shutDownTime,_deleting=!1,_authToken,_lastFilePicker="Local",_localAuth=!1,_authTokenCloud,_lastSamplePick,_audioPreview;sync.render("ui_filePicker",function(e,t,a){a=a||{};var i=$("<div>");i.addClass("fit-xy flexcolumn");var o=genNavBar(null,"flex");o.addClass("fit-x flex"),o.appendTo(i),(!a.filter||"img"==a.filter||a.filter instanceof Object&&util.contains(a.filter,"img"))&&o.generateTab("Sample Content","folder-open",function(e){var a=$("<div>").appendTo(e);a.addClass("flexcolumn flex"),layout.mobile||(a.on("dragover",function(e){if(e.preventDefault(),e.stopPropagation(),!$("#"+t.attr("id")+"-drag-overlay").length){var a=layout.overlay({target:i,id:t.attr("id")+"-drag-overlay",style:{"background-color":"rgba(0,0,0,0.5)","pointer-events":"none","z-index":"1000000000000"}});a.addClass("flexcolumn flexmiddle alttext"),a.css("z-index",util.getMaxZ(".ui-popout")+1),a.css("font-size","2em"),a.append("<b>Drop to Upload</b>")}}),a.on("drop",function(e){e.preventDefault(),e.stopPropagation();var a=e.originalEvent.dataTransfer;if(a.getData("Text")){var i=new Image;i.src=a.getData("Text"),i.onload=function(){n.val($(this).attr("src")),n.change()}}layout.coverlay(t.attr("id")+"-drag-overlay")}),a.on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),layout.coverlay(t.attr("id")+"-drag-overlay")}),a.mouseout(function(){layout.coverlay(t.attr("id")+"-drag-overlay")}));var o=genNavBar(null,"flex","4px");o.addClass("fit-x flex"),o.removeClass("flexcolumn"),o.addClass("flexrow"),$(o.children()[0]).removeClass("flexrow").addClass("flexcolumn subtitle middle"),o.appendTo(a);for(var s in util.art)!function(e){o.generateTab(e,"",function(t){t.css("position","relative"),t.css("overflow","auto"),_lastSamplePick=e;var a=$("<div>").appendTo(t);a.addClass("flexrow flexwrap fit-x"),a.css("position","absolute");for(var i in util.art[e]){var o=$("<img>").appendTo(a);o.addClass("outline hover2"),
o.css("cursor","pointer"),"Icons"==e||"Nouns"==e?(o.css("width","48px"),o.css("height","48px")):(o.css("height","128px"),a.addClass("flexaround flex")),util.art[e][i]instanceof Object?o.attr("src",util.art[e][i].src):o.attr("src","/content/icons/"+util.art[e][i]),o.click(function(){n.val($(this).attr("src")),n.change()})}if($("<div>").addClass("flex").appendTo(t),"Nouns"==e){var s=$("<div>").appendTo(t);s.addClass("subtitle bold flexmiddle alttext outline smooth"),s.css("background-color","rgba(0,0,0,0.8)"),s.append("<a href='/content/nouns/credits.txt' target='_' class='lrpadding lrmargin'>Art by : The Noun Project</a>")}if("Sci-fi"==e){var s=$("<div>").appendTo(t);s.addClass("subtitle bold flexmiddle alttext outline smooth"),s.css("background-color","rgba(0,0,0,0.8)"),s.append("<a href='http://thompsonpeters.com/eote/maps/' target='_' class='lrpadding lrmargin'>Art by : Peter Thompson,<br> check out his site!</a>");var o=$("<img>").appendTo(s);o.addClass("round"),o.attr("src","/content/peter/peter.png"),o.css("width","64px"),o.css("height","64px")}if("Area"==e){var s=$("<div>").appendTo(t);s.addClass("subtitle bold flexmiddle alttext outline smooth"),s.css("background-color","rgba(0,0,0,0.8)"),s.append("<a href='https://www.patreon.com/blueswordgames' target='_' class='lrpadding lrmargin'>Art by : Blue Sword Games,<br> check out his patreon!</a>");var o=$("<img>").appendTo(s);o.addClass("round"),o.attr("src","/content/bluesword/bluesword.jpg"),o.css("width","64px"),o.css("height","64px")}if("Dungeons"==e){var s=$("<div>").appendTo(t);s.addClass("subtitle bold flexmiddle alttext outline smooth"),s.css("background-color","rgba(0,0,0,0.8)"),s.append("<a href='https://www.patreon.com/elventower' target='_' class='lrpadding lrmargin'>Art by : Elven Tower Cartography,<br> check out his patreon!</a>");var o=$("<img>").appendTo(s);o.attr("src","/content/etc/etc.png"),o.css("width","64px"),o.css("height","64px")}if("Worldmaps"==e){var s=$("<div>").appendTo(t);s.addClass("subtitle bold flexmiddle alttext outline smooth"),s.css("background-color","rgba(0,0,0,0.8)"),s.append("<a href='https://arsheesh.deviantart.com/art/A-Free-Fantasy-Map-294623008' target='_' class='lrpadding lrmargin'>Art by : Arsheesh,<br> check out his deviantart!</a>");var o=$("<img>").appendTo(s);o.attr("src","https://a.deviantart.net/avatars/a/r/arsheesh.png?5"),o.css("width","64px"),o.css("height","64px")}})}(s);o.selectTab(_lastSamplePick||"Icons"),_lastFilePicker=null}),layout.mobile||o.generateTab("Local","inbox",function(i){sync.render("ui_fileBrowser")(e,t,{filter:a.filter,change:function(e,t,a){n.val(a),n.change()}}).appendTo(i),_lastFilePicker="Local"});var s=$("<div>").appendTo(i);s.addClass("flexrow subtitle"),a.hideURL&&s.hide();var n=genInput({parent:s,placeholder:"Direct URL",value:a.value});n.addClass("flex"),n.change(function(e){if(a.change&&a.change instanceof Function){var t=$(this).val().split("\\"),i="";for(var o in t)i+=t[o],o<t.length-1&&(i+="/");a.change(e,$(this),i)}});var r=$("<div>").appendTo(s);return r.addClass("background hover2 outline smooth alttext flexmiddle spadding"),r.css("font-size","1.2em"),r.text("Clear/Delete"),r.click(function(){n.val(""),n.change()}),o.selectTab(_lastFilePicker||"Sample Content"),i}),sync.render("ui_fileBrowser",function(e,t,a){function i(o){function l(e,t){var o=$("<div>");o.addClass("flexcolumn"),o.css("color","#333");var d=$("<div>");d.addClass("flexcolumn outlinebottom");var p;e.path?p=genIcon("folder-close"):(p=genIcon("folder-close","New Folder"),p.addClass("subtitle")),p.addClass("alttext lrpadding"),p.attr("filename",e.path),p.css("color","white"),p.click(function(e){var t=$(this).attr("filename")||"\\";ui_prompt({target:$(this),id:"hover",inputs:{"Folder Name":{placeholder:"Enter Folder Name"}},click:function(e,a){a["Folder Name"].val()&&(sendAlert({text:"Creating..."}),_deleting=!0,$.ajax({url:n+"/create",data:{path:t+a["Folder Name"].val(),userID:getCookie("UserID"),auth:r},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Creation Failed"})},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Created Folder\\custom\\"+t+a["Folder Name"].val()})}}))}}),e.stopPropagation(),e.preventDefault()});var g=$("<div>").appendTo(d);g.addClass("flexcolumn smooth");var m=$("<div>").appendTo(d);if(m.addClass("flexcolumn smooth fileContent"),m.attr("path",e.path),m.sortable({connectWith:".fileContent",update:function(e,t){e.stopPropagation(),e.preventDefault();var t=$(t.item),a=!1;if(m.children().each(function(){$(this).attr("path")==t.attr("path")&&(a=!0)}),a)$(t.item).remove();else{var o=m.attr("path"),s=t.attr("filename").replace(t.attr("path"),""),l=t.attr("filename"),d="";"\\"!=l[0]&&"/"!=l[0]?l="\\"+l:d="\\",$.ajax({url:n+"/move",data:{userID:getCookie("UserID"),auth:r,path:l,newPath:o+d+s},error:function(e){console.log(e),e.responseText&&sendAlert({text:e.responseText}),$.ajax({url:n+"/files",error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"})},dataType:"json",success:function(e){i(e)}})}}}),e.path){var f=e.path;f=f.substring(0,f.length-1),f=f.split("\\"),f=f[f.length-1];var h=$("<div>").appendTo(o);h.addClass("flexrow flexbetween lrpadding smooth alttext bold hover2"),h.attr("filename",e.path),h.css("text-align","left");var v=(genIcon("",f).appendTo(h),$("<div>").appendTo(h));v.addClass("flexrow");var y=genIcon("cloud-upload").appendTo(v);y.attr("filename",e.path),y.attr("title","Upload file to folder"),y.click(function(e){u.attr("path",$(this).attr("filename")),u.click(),e.stopPropagation(),e.preventDefault()}),p.appendTo(v),p.attr("title","Creates a new folder in this folder");var x=genIcon("trash").appendTo(v);x.attr("filename",e.path),x.click(function(e){var t=$(this).attr("filename");_deleting?sendAlert({text:"Deletion in progress"}):("\\"!=t[0]&&"/"!=t[0]&&(t="\\"+t),ui_prompt({target:$(this),confirm:"Delete Folder",inputs:{Confirmation:{placeholder:"Type 'Delete' to confirm"}},click:function(e,a){"Delete"==a.Confirmation.val()&&(_deleting=!0,sendAlert({text:"Deleting..."}),h.remove(),$.ajax({url:n+"/delete",data:{userID:getCookie("UserID"),auth:r,path:t},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Deletion Failed..."})},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Deleted Successfully..."})}}))}})),e.stopPropagation(),e.preventDefault()}),h.click(function(){m.is(":visible")?($(this).removeClass("highlight outlinebottom"),$(this).addClass("background"),d.hide(),delete s.data[$(this).attr("filename")]):(s.data[$(this).attr("filename")]=!0,$(this).removeClass("background"),$(this).addClass("highlight outlinebottom"),d.show())}),g.css("margin-left","1em"),m.css("margin-left","1em"),m.css("margin-bottom","4px"),m.css("min-height","1px"),s.data[e.path]?(h.addClass("highlight outlinebottom"),d.show()):(h.addClass("background"),d.hide())}else if(c.children().length<=1){p.appendTo(c),p.removeClass("subtitle");var y=genIcon("cloud-upload","Upload").appendTo(c);y.addClass("alttext lrpadding"),y.attr("filename","/"),y.css("color","white"),y.click(function(e){u.attr("path",$(this).attr("filename")),u.click(),e.stopPropagation(),e.preventDefault()})}d.appendTo(o);for(var b in e.c){var w=e.c[b];if(w instanceof Object)l(w,(t||0)+1).appendTo(g);else{var C=w;C=C.split("\\"),C=C[C.length-1];var k=$("<div>").appendTo(m);k.addClass("flexrow lrpadding outlinebottom smooth white"),k.attr("filename",w),k.attr("path",e.path),k.css("text-align","left"),b==e.c.length-1&&k.removeClass("outlinebottom"),k.contextmenu(function(e){var t=$(this),a=t.attr("filename").replace(t.attr("path"),""),o=t.attr("filename");ui_prompt({target:$(this),inputs:{Rename:{value:a.split(".")[0],style:{width:"300px",display:"block"}}},click:function(e,s){if(s.Rename.val()&&s.Rename.val().trim()&&!s.Rename.val().match("\\.\\.")){"\\"!=o[0]&&"/"!=o[0]?o="\\"+o:"\\",$(t.children()[2]).text("Renaming..."),$.ajax({url:n+"/move",data:{userID:getCookie("UserID"),auth:r,path:o,newPath:o.replace(a,s.Rename.val()+"."+a.split(".")[1])},error:function(e){console.log(e),e.responseText&&sendAlert({text:e.responseText}),$.ajax({url:n+"/files",error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"})},dataType:"json",success:function(e){i(e)}})}}}),e.stopPropagation(),e.preventDefault()}),a.change&&a.change instanceof Function&&(k.addClass("hover2"),k.click(function(e){pathToFile=$(this).attr("filename"),"\\"!=pathToFile[0]&&"/"!=pathToFile[0]&&(pathToFile="\\"+pathToFile),a.change(e,$(this),game.user.token+"\\custom\\"+pathToFile)}));var T="",_=w.split("\\");for(var b in _)T+=_[b],b!=_.length-1&&(T+="/");var D=util.mediaType(T.toLowerCase()),I=$("<img>").appendTo(k);if(I.addClass("hover2"),I.attr("type",D),I.css("font-size","20px"),I.css("height","25px"),I.css("width","auto"),I.mousedown(function(e){e.stopPropagation()}),e.path?I.attr("srcFile","\\custom"+T):I.attr("srcFile","\\custom\\"+T),"img"==D)I.attr("src",I.attr("srcFile"));else if("audio"==D){var A=genIcon("volume-up");A.attr("src",I.attr("srcFile")),A.click(function(){_audioPreview&&_audioPreview.src==$(this).attr("src")?_audioPreview.paused?_audioPreview.play():_audioPreview.pause():(_audioPreview&&_audioPreview.pause(),_audioPreview=new Audio($(this).attr("src")),_audioPreview.volume=.2,_audioPreview.oncanplay=function(){_audioPreview.loadcheck||(_audioPreview.currentTime=Math.round((_audioPreview.duration||10)/2),_audioPreview.loadcheck=!0,_audioPreview.play())})}),I.replaceWith(A)}else"video"==D?I.replaceWith(genIcon("media")):"pdf"==D?I.replaceWith(genIcon("book")):I.replaceWith(genIcon("list-alt"));D&&a.filter&&(a.filter!=D.toLowerCase()||a.filter instanceof Object&&!util.contains(a.filter,D.toLowerCase()))?(k.removeClass("hover2"),k.addClass("subtitle"),k.css("background-color","rgb(235,235,228)"),I.css("height","15px")):assetTypes[D]&&(I.click(function(e){assetTypes[I.attr("type")].preview(e,$(this),$(this).attr("src")),e.stopPropagation(),e.preventDefault()}),I.contextmenu(function(e){return assetTypes[$(this).attr("type")].contextmenu(e,$(this),$(this).attr("src")),e.stopPropagation(),e.preventDefault(),!1})),k.append("<div class='flex'></div>");genIcon("",C).appendTo(k).addClass("flexmiddle"),k.append("<div class='flex'></div>");var x=genIcon("trash").appendTo(k);x.addClass("destroy"),x.attr("filename",w),x.click(function(e){var t=$(this).attr("filename");if(_deleting)sendAlert({text:"Deletion in progress"});else{"\\"!=t[0]&&"/"!=t[0]&&(t="\\"+t);var a=$(this).parent();ui_prompt({target:$(this),confirm:"Confirm Delete",click:function(e,o){_deleting=!0,a.remove(),sendAlert({text:"Deleting..."}),$.ajax({url:n+"/delete",data:{userID:getCookie("UserID"),auth:r,path:t},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Deletion Failed..."})},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Deletion Successful"})}})}})}e.stopPropagation(),e.preventDefault()})}}return o}if(_localAuth=o,m.empty(),l(o).removeClass("outline").appendTo(m),p.empty(),o.size){p.append(sync.render("ui_progressBar")(e||{data:{}},t,{percentage:o.size,max:o.max,col:"rgb(@:int(200*@percentage),@:int(200-200*@percentage),0)"}).removeClass("fit-x").addClass("flex"));var d=$("<div class='alttext flexmiddle lrmargin' style='position : relative;'><div style='position : absolute; text-overflow: ellipsis; width : 50px;'>"+Math.round(o.size/o.max*100)+"%</div></div>").appendTo(p);d.css("transition","width 0.5s"),d.css("width","50px"),p.hover(function(){d.css("width","120px"),d.empty(),d.append("<div style='position : absolute; text-overflow: ellipsis; width : 120px;'>"+Math.round(o.size/1024/1024)+"mb / 100mb</div>"),d.text()},function(){d.css("width","50px"),d.empty(),d.append("<div style='position : absolute; text-overflow: ellipsis; width : 50px;'>"+Math.round(o.size/o.max*100)+"%</div>")})}}function o(){$.ajax({url:"/files",error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"})}a=a||{},game.locals.localFolders=game.locals.localFolders||sync.obj(),game.locals.localFolders.data=game.locals.localFolders.data||{};var s=game.locals.localFolders,n="http://127.0.0.1:30000",r="";game.user={token:""};var l=$("<div>");l.addClass("fit-xy flexcolumn"),layout.mobile||(l.on("dragover",function(e){if(e.preventDefault(),e.stopPropagation(),!$("#"+t.attr("id")+"-drag-overlay").length){var a=layout.overlay({target:l,id:t.attr("id")+"-drag-overlay",style:{"background-color":"rgba(0,0,0,0.5)","pointer-events":"none"}});a.addClass("flexcolumn flexmiddle alttext"),a.css("font-size","2em"),a.css("z-index",util.getMaxZ(".ui-popout")+1),a.append("<b>Drop to Upload</b>")}}),l.on("drop",function(e){e.preventDefault(),e.stopPropagation();var o=e.originalEvent.dataTransfer,s=o.files;if(s.length)for(var l=[],d={},c=0;c<s.length;c++)s[c].size<20971520?function(e,t){var a=new FileReader;a.readAsDataURL(e),a.onload=function(e){d[t]=!0,l.push({name:s[t].name,blob:e.target.result.split(",")[1],path:"/"});for(var a=0;a<s.length;a++)if(!d[a])return!1;var o;u[0].files.length>1?sendAlert({text:"Uploading files...",duration:-1,id:"file-chunk"}):(o="file-"+t,sendAlert({text:"Uploading "+s[t].name+"...",duration:-1,id:"file-"+t})),$.ajax({type:"POST",url:n+"/upload",data:{upload:l,userID:getCookie("UserID"),auth:r},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Uploading Failed : "+e.responseText}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(o,1e3)},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Upload Successful"}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(o,1e3)}})}}(s[c],c):sendAlert({text:s[c].name+" is larger than 20mb!"});else if(o.getData("Text")){var p=new Image;p.src=o.getData("Text"),p.onload=function(){a.change&&a.change instanceof Function&&a.change(e,$(this),p.src)}}layout.coverlay(t.attr("id")+"-drag-overlay")}),l.on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),layout.coverlay(t.attr("id")+"-drag-overlay")}),l.mouseout(function(){layout.coverlay(t.attr("id")+"-drag-overlay")}));var d=$("<div>");d.addClass("flexrow flexbetween subtitle foreground outline smooth fit-x");var c=$("<div>").appendTo(d);c.addClass("flexrow flexmiddle");var p=$("<div>").appendTo(d);p.addClass("flex flexrow flexmiddle lrmargin");var u=genInput({type:"file",parent:d}).addClass("white outline smooth");u.css("opacity","0"),u.css("width","1px"),u.change(function(){if(u.attr("path")){var e=u.attr("path").split("\\"),t="";for(var a in e)t+=e[a],a<e.length-1&&(t+="/");for(var o=[],s={},a=0;a<u[0].files.length;a++)u[0].files[a].size<20971520?function(e,a){var l=new FileReader;l.readAsDataURL(e),l.onload=function(e){s[a]=!0,o.push({name:u[0].files[a].name,blob:e.target.result.split(",")[1],path:t});for(var l=0;l<u[0].files.length;l++)if(!s[l])return!1;var d;u[0].files.length>1?sendAlert({text:"Uploading files...",duration:-1,id:"file-chunk"}):(d="file-"+a,sendAlert({text:"Uploading "+u[0].files[a].name+"...",duration:-1,id:"file-"+a})),$.ajax({type:"POST",url:n+"/upload",data:{upload:o,userID:getCookie("UserID"),auth:r},error:function(e){_deleting=!1,sendAlert({text:"Uploading Failed : "+e.responseText}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(d,1e3)},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Upload Successful"}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(d,1e3)}}),u.removeAttr("path"),u.val("")}}(u[0].files[a],a):sendAlert({text:u[0].files[a].name+" is larger than 20mb!"})}});var g=$("<div>").appendTo(l);g.addClass("flex"),g.css("position","relative"),g.css("overflow-y","auto"),g.css("overflow-x","hidden"),g.css("cursor","pointer"),g.click(function(e){u.click(),e.stopPropagation(),e.preventDefault()});var m=$("<div>").appendTo(g);m.addClass("fit-x flexcolumn flexwrap"),m.css("position","absolute"),m.click(function(e){e.stopPropagation(),e.preventDefault()});var f=$("<div>").appendTo(m);f.addClass("fit-xy flexcolumn flexmiddle lpadding");var h=$("<text>").appendTo(f);h.addClass("flexmiddle flex middle"),h.css("font-size","2em"),h.css("-webkit-text-stroke-width","2px"),h.text("Establishing Connection...");var v=($("<div class='loader' style='height : 50px; width : 50px;'></div>").appendTo(f),genIcon("refresh","Refresh").appendTo(c));return v.addClass("alttext lrpadding"),v.css("color","white"),v.click(function(){sendAlert({text:"Refreshing"}),n=_localAuth,o()}),_localAuth?(m.addClass("foreground outline"),$.ajax({url:"/files?userID="+getCookie("UserID")+"&auth="+r,error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"}),i(_localAuth)):o(),d.appendTo(l),l}),sync.render("ui_gameCtrl",function(e,t,a){e||(e=game.config);var i=$("<div>");e&&e.data&&e.data;var o=$("<div>").appendTo(i);o.addClass("flexrow flexbetween");var s=$("<div>").appendTo(o);s.css("flex","1");var n=$("<div>").appendTo(s);n.addClass("flexcolumn"),genIcon("plus","Add Extension").click(function(){var a=sync.render("ui_filePicker")(e,t,{filter:"js",change:function(a,i,o){game.config.data.scripts=game.config.data.scripts||[],game.config.data.scripts.push(o),e.sync("updateConfig"),sync.updateApp(t,game.config),layout.coverlay("icons-picker")}});ui_popOut({target:$(this),prompt:!0,id:"icons-picker",align:"top",style:{width:assetTypes.filePicker.width,height:assetTypes.filePicker.height}},a).resizable()});for(var r in game.config.data.scripts){var l=$("<b class='subtitle'>"+game.config.data.scripts[r]+"</b>").appendTo(n),d=genIcon("remove").appendTo(l);d.addClass("destroy"),d.attr("index",r),d.click(function(){$(this).parent().remove(),game.config.data.scripts=game.config.data.scripts||[],game.config.data.scripts.splice($(this).attr("index"),1),e.sync("updateConfig")})}var c=$("<button>").appendTo(s);c.addClass("focus"),c.append("CHANGE GAME"),c.click(function(){ui_prompt({target:$(this),inputs:{Game:game.config.data.game},click:function(e,t){game.locals.gameList[t.Game.val()]&&(game.config.data.game=t.Game.val(),game.config.sync("updateConfig"))}})});var c=$("<button>").appendTo(s);if(c.addClass("focus"),c.append("RESTORE ORIGNAL TEMPLATES"),c.click(function(){game.locals.gameList[game.config.data.game]?runCommand("updateTemplate",duplicate(game.locals.gameList[game.config.data.game].templates)):sendAlert({text:"This is a custom game, can't restore templates(still being built)"})}),!game.config.data.offline){var p=$("<button>");p.attr("title","Edit in Offline Mode"),p.append("Go Offline"),p.click(function(){setCookie("offlineGame"),runCommand("goOffline"),layout.coverlay("game-options-popout")})}return i});